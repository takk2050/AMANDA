"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto"),r=t(e),n=require("uuid"),i=t(require("axios")),s=require("jsonwebtoken"),o=require("node-forge"),a=t(o),u=require("int64-buffer"),c=require("sha3"),f=t(require("https")),p=require("fs"),h=require("path"),d=require("tweetnacl"),l=require("@noble/ed25519"),y=require("bignumber.js"),g=require("pako"),m=t(require("ws")),v=require("ethers");function b(t,e,r,n,i,s,o){try{var a=t[s](o),u=a.value}catch(t){return void r(t)}a.done?e(u):Promise.resolve(u).then(n,i)}function w(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var s=t.apply(e,r);function o(t){b(s,n,i,o,a,"next",t)}function a(t){b(s,n,i,o,a,"throw",t)}o(void 0)}))}}function x(){return(x=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function _(t,e){return(_=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function E(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function k(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return E(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?E(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var M,B=(function(t){var e=function(t){var e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function a(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{a({},"")}catch(t){a=function(t,e,r){return t[e]=r}}function u(t,e,r,n){var i=Object.create((e&&e.prototype instanceof p?e:p).prototype),s=new E(n||[]);return i._invoke=function(t,e,r){var n="suspendedStart";return function(i,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw s;return{value:void 0,done:!0}}for(r.method=i,r.arg=s;;){var o=r.delegate;if(o){var a=w(o,r);if(a){if(a===f)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=c(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===f)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(t,r,s),i}function c(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var f={};function p(){}function h(){}function d(){}var l={};a(l,i,(function(){return this}));var y=Object.getPrototypeOf,g=y&&y(y(k([])));g&&g!==e&&r.call(g,i)&&(l=g);var m=d.prototype=p.prototype=Object.create(l);function v(t){["next","throw","return"].forEach((function(e){a(t,e,(function(t){return this._invoke(e,t)}))}))}function b(t,e){var n;this._invoke=function(i,s){function o(){return new e((function(n,o){!function n(i,s,o,a){var u=c(t[i],t,s);if("throw"!==u.type){var f=u.arg,p=f.value;return p&&"object"==typeof p&&r.call(p,"__await")?e.resolve(p.__await).then((function(t){n("next",t,o,a)}),(function(t){n("throw",t,o,a)})):e.resolve(p).then((function(t){f.value=t,o(f)}),(function(t){return n("throw",t,o,a)}))}a(u.arg)}(i,s,n,o)}))}return n=n?n.then(o,o):o()}}function w(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,w(t,e),"throw"===e.method))return f;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=c(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,f;var i=n.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,f):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,f)}function x(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function _(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(x,this),this.reset(!0)}function k(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,s=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return s.next=s}}return{next:M}}function M(){return{value:void 0,done:!0}}return h.prototype=d,a(m,"constructor",d),a(d,"constructor",h),h.displayName=a(d,o,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):(t.__proto__=d,a(t,o,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},v(b.prototype),a(b.prototype,s,(function(){return this})),t.AsyncIterator=b,t.async=function(e,r,n,i,s){void 0===s&&(s=Promise);var o=new b(u(e,r,n,i),s);return t.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},v(m),a(m,o,"Generator"),a(m,i,(function(){return this})),a(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=k,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return o.type="throw",o.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],o=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var a=r.call(s,"catchLoc"),u=r.call(s,"finallyLoc");if(a&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(a){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===t||"continue"===t)&&s.tryLoc<=e&&e<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=t,o.arg=e,s?(this.method="next",this.next=s.finallyLoc,f):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),_(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;_(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:k(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},t}(t.exports);try{regeneratorRuntime=e}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}}(M={exports:{}}),M.exports),T=function(t,r,n){var i=t.session_id,s=t.private_key,a=t.pin_token;if(!(r=r||t.pin))throw new Error("PIN is required");var c,f,p=A(s,"base64"),h=64===p.length?(c=a,f=p,c=Buffer.from(c,"base64"),function(t,e){t[0]&=248,t[31]&=127,t[31]|=64;var r=new Uint8Array(32);return function(t,e,r){var n,i,s=new Uint8Array(32),o=new Float64Array(80),a=S(),u=S(),c=S(),f=S(),p=S(),h=S();for(i=0;i<31;i++)s[i]=e[i];for(s[31]=127&e[31]|64,s[0]&=248,function(t,e){var r;for(r=0;r<16;r++)t[r]=e[2*r]+(e[2*r+1]<<8);t[15]&=32767}(o,r),i=0;i<16;i++)u[i]=o[i],f[i]=a[i]=c[i]=0;for(a[0]=f[0]=1,i=254;i>=0;--i)C(a,u,n=s[i>>>3]>>>(7&i)&1),C(c,f,n),N(p,a,c),P(a,a,c),N(c,u,f),P(u,u,f),L(f,p),L(h,a),O(a,c,a),O(c,u,p),N(p,a,c),P(a,a,c),L(u,a),P(c,f,h),O(a,c,S([56129,1])),N(a,a,f),O(c,c,a),O(a,f,h),O(f,u,o),L(u,p),C(a,u,n),C(c,f,n);for(i=0;i<16;i++)o[i+16]=a[i],o[i+32]=c[i],o[i+48]=u[i],o[i+64]=f[i];var d=o.subarray(32),l=o.subarray(16);(function(t,e){var r,n=S();for(r=0;r<16;r++)n[r]=e[r];for(r=253;r>=0;r--)L(n,n),2!==r&&4!==r&&O(n,n,e);for(r=0;r<16;r++)t[r]=n[r]})(d,d),O(l,l,d),function(t,e){var r,n,i,s=S(),o=S();for(r=0;r<16;r++)o[r]=e[r];for(U(o),U(o),U(o),n=0;n<2;n++){for(s[0]=o[0]-65517,r=1;r<15;r++)s[r]=o[r]-65535-(s[r-1]>>16&1),s[r-1]&=65535;s[15]=o[15]-32767-(s[14]>>16&1),i=s[15]>>16&1,s[14]&=65535,C(o,s,1-i)}for(r=0;r<16;r++)t[2*r]=255&o[r],t[2*r+1]=o[r]>>8}(t,l)}(r,t,e),r}(function(t){var r=t.slice(0,32),n=e.createHash("sha512");n.write(r,"binary");var i=n.digest();return i[0]&=248,i[31]&=127,i[31]|=64,i.slice(0,32)}(f),c.slice(0,32))):function(t,e,r){t=Buffer.from(t,"base64");var n=(e=o.pki.privateKeyFromPem(e)).decrypt(t,"RSA-OAEP",{md:o.md.sha256.create(),label:r});return function(t){for(var e=new Uint8Array(32),r=0;r<t.length;r+=2)e[r/2]=parseInt(t.substr(r,2),16);return e}(o.util.binary.hex.encode(n))}(a,s,i),d=new u.Uint64LE(Date.now()/1e3|0).toBuffer();null!=n&&""!==n||(n=1e6*Date.now()),n=new u.Uint64LE(n).toBuffer(),r=Buffer.from(r,"utf8");for(var l=Buffer.concat([r,Buffer.from(d),Buffer.from(n)]),y=16-l.length%16,g=[],m=0;m<y;m++)g.push(y);l=Buffer.concat([l,Buffer.from(g)]);var v=e.randomBytes(16),b=e.createCipheriv("aes-256-cbc",h,v);b.setAutoPadding(!1);var w=b.update(l,"utf-8");return w=Buffer.concat([v,w]),Buffer.from(w).toString("base64")};function A(t,e){return void 0===e&&(e="utf8"),"object"==typeof t&&(t=JSON.stringify(t)),Buffer.from(t,e)}var q=function(t,e,r){return void 0===r&&(r=""),e.startsWith("https://api.mixin.one")&&(e=e.replace("https://api.mixin.one","")),e.startsWith("https://mixin-api.zeromesh.net")&&(e=e.replace("https://mixin-api.zeromesh.net","")),"object"==typeof r&&(r=JSON.stringify(r)),t=t.toUpperCase(),o.md.sha256.create().update(t+e+r,"utf8").digest().toHex()};function I(t){return Buffer.from(t).toString("base64").replace(/\=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function S(t){void 0===t&&(t=void 0);var e,r=new Float64Array(16);if(t)for(e=0;e<t.length;e++)r[e]=t[e];return r}function C(t,e,r){for(var n,i=~(r-1),s=0;s<16;s++)t[s]^=n=i&(t[s]^e[s]),e[s]^=n}function N(t,e,r){for(var n=0;n<16;n++)t[n]=e[n]+r[n]}function P(t,e,r){for(var n=0;n<16;n++)t[n]=e[n]-r[n]}function O(t,e,r){var n,i,s=0,o=0,a=0,u=0,c=0,f=0,p=0,h=0,d=0,l=0,y=0,g=0,m=0,v=0,b=0,w=0,x=0,_=0,E=0,k=0,M=0,B=0,T=0,A=0,q=0,I=0,S=0,C=0,N=0,P=0,O=0,L=r[0],U=r[1],D=r[2],R=r[3],j=r[4],z=r[5],G=r[6],F=r[7],Y=r[8],J=r[9],K=r[10],W=r[11],H=r[12],V=r[13],X=r[14],$=r[15];s+=(n=e[0])*L,o+=n*U,a+=n*D,u+=n*R,c+=n*j,f+=n*z,p+=n*G,h+=n*F,d+=n*Y,l+=n*J,y+=n*K,g+=n*W,m+=n*H,v+=n*V,b+=n*X,w+=n*$,o+=(n=e[1])*L,a+=n*U,u+=n*D,c+=n*R,f+=n*j,p+=n*z,h+=n*G,d+=n*F,l+=n*Y,y+=n*J,g+=n*K,m+=n*W,v+=n*H,b+=n*V,w+=n*X,x+=n*$,a+=(n=e[2])*L,u+=n*U,c+=n*D,f+=n*R,p+=n*j,h+=n*z,d+=n*G,l+=n*F,y+=n*Y,g+=n*J,m+=n*K,v+=n*W,b+=n*H,w+=n*V,x+=n*X,_+=n*$,u+=(n=e[3])*L,c+=n*U,f+=n*D,p+=n*R,h+=n*j,d+=n*z,l+=n*G,y+=n*F,g+=n*Y,m+=n*J,v+=n*K,b+=n*W,w+=n*H,x+=n*V,_+=n*X,E+=n*$,c+=(n=e[4])*L,f+=n*U,p+=n*D,h+=n*R,d+=n*j,l+=n*z,y+=n*G,g+=n*F,m+=n*Y,v+=n*J,b+=n*K,w+=n*W,x+=n*H,_+=n*V,E+=n*X,k+=n*$,f+=(n=e[5])*L,p+=n*U,h+=n*D,d+=n*R,l+=n*j,y+=n*z,g+=n*G,m+=n*F,v+=n*Y,b+=n*J,w+=n*K,x+=n*W,_+=n*H,E+=n*V,k+=n*X,M+=n*$,p+=(n=e[6])*L,h+=n*U,d+=n*D,l+=n*R,y+=n*j,g+=n*z,m+=n*G,v+=n*F,b+=n*Y,w+=n*J,x+=n*K,_+=n*W,E+=n*H,k+=n*V,M+=n*X,B+=n*$,h+=(n=e[7])*L,d+=n*U,l+=n*D,y+=n*R,g+=n*j,m+=n*z,v+=n*G,b+=n*F,w+=n*Y,x+=n*J,_+=n*K,E+=n*W,k+=n*H,M+=n*V,B+=n*X,T+=n*$,d+=(n=e[8])*L,l+=n*U,y+=n*D,g+=n*R,m+=n*j,v+=n*z,b+=n*G,w+=n*F,x+=n*Y,_+=n*J,E+=n*K,k+=n*W,M+=n*H,B+=n*V,T+=n*X,A+=n*$,l+=(n=e[9])*L,y+=n*U,g+=n*D,m+=n*R,v+=n*j,b+=n*z,w+=n*G,x+=n*F,_+=n*Y,E+=n*J,k+=n*K,M+=n*W,B+=n*H,T+=n*V,A+=n*X,q+=n*$,y+=(n=e[10])*L,g+=n*U,m+=n*D,v+=n*R,b+=n*j,w+=n*z,x+=n*G,_+=n*F,E+=n*Y,k+=n*J,M+=n*K,B+=n*W,T+=n*H,A+=n*V,q+=n*X,I+=n*$,g+=(n=e[11])*L,m+=n*U,v+=n*D,b+=n*R,w+=n*j,x+=n*z,_+=n*G,E+=n*F,k+=n*Y,M+=n*J,B+=n*K,T+=n*W,A+=n*H,q+=n*V,I+=n*X,S+=n*$,m+=(n=e[12])*L,v+=n*U,b+=n*D,w+=n*R,x+=n*j,_+=n*z,E+=n*G,k+=n*F,M+=n*Y,B+=n*J,T+=n*K,A+=n*W,q+=n*H,I+=n*V,S+=n*X,C+=n*$,v+=(n=e[13])*L,b+=n*U,w+=n*D,x+=n*R,_+=n*j,E+=n*z,k+=n*G,M+=n*F,B+=n*Y,T+=n*J,A+=n*K,q+=n*W,I+=n*H,S+=n*V,C+=n*X,N+=n*$,b+=(n=e[14])*L,w+=n*U,x+=n*D,_+=n*R,E+=n*j,k+=n*z,M+=n*G,B+=n*F,T+=n*Y,A+=n*J,q+=n*K,I+=n*W,S+=n*H,C+=n*V,N+=n*X,P+=n*$,w+=(n=e[15])*L,o+=38*(_+=n*D),a+=38*(E+=n*R),u+=38*(k+=n*j),c+=38*(M+=n*z),f+=38*(B+=n*G),p+=38*(T+=n*F),h+=38*(A+=n*Y),d+=38*(q+=n*J),l+=38*(I+=n*K),y+=38*(S+=n*W),g+=38*(C+=n*H),m+=38*(N+=n*V),v+=38*(P+=n*X),b+=38*(O+=n*$),s=(n=(s+=38*(x+=n*U))+(i=1)+65535)-65536*(i=Math.floor(n/65536)),o=(n=o+i+65535)-65536*(i=Math.floor(n/65536)),a=(n=a+i+65535)-65536*(i=Math.floor(n/65536)),u=(n=u+i+65535)-65536*(i=Math.floor(n/65536)),c=(n=c+i+65535)-65536*(i=Math.floor(n/65536)),f=(n=f+i+65535)-65536*(i=Math.floor(n/65536)),p=(n=p+i+65535)-65536*(i=Math.floor(n/65536)),h=(n=h+i+65535)-65536*(i=Math.floor(n/65536)),d=(n=d+i+65535)-65536*(i=Math.floor(n/65536)),l=(n=l+i+65535)-65536*(i=Math.floor(n/65536)),y=(n=y+i+65535)-65536*(i=Math.floor(n/65536)),g=(n=g+i+65535)-65536*(i=Math.floor(n/65536)),m=(n=m+i+65535)-65536*(i=Math.floor(n/65536)),v=(n=v+i+65535)-65536*(i=Math.floor(n/65536)),b=(n=b+i+65535)-65536*(i=Math.floor(n/65536)),w=(n=w+i+65535)-65536*(i=Math.floor(n/65536)),s=(n=(s+=i-1+37*(i-1))+(i=1)+65535)-65536*(i=Math.floor(n/65536)),o=(n=o+i+65535)-65536*(i=Math.floor(n/65536)),a=(n=a+i+65535)-65536*(i=Math.floor(n/65536)),u=(n=u+i+65535)-65536*(i=Math.floor(n/65536)),c=(n=c+i+65535)-65536*(i=Math.floor(n/65536)),f=(n=f+i+65535)-65536*(i=Math.floor(n/65536)),p=(n=p+i+65535)-65536*(i=Math.floor(n/65536)),h=(n=h+i+65535)-65536*(i=Math.floor(n/65536)),d=(n=d+i+65535)-65536*(i=Math.floor(n/65536)),l=(n=l+i+65535)-65536*(i=Math.floor(n/65536)),y=(n=y+i+65535)-65536*(i=Math.floor(n/65536)),g=(n=g+i+65535)-65536*(i=Math.floor(n/65536)),m=(n=m+i+65535)-65536*(i=Math.floor(n/65536)),v=(n=v+i+65535)-65536*(i=Math.floor(n/65536)),b=(n=b+i+65535)-65536*(i=Math.floor(n/65536)),w=(n=w+i+65535)-65536*(i=Math.floor(n/65536)),t[0]=s+=i-1+37*(i-1),t[1]=o,t[2]=a,t[3]=u,t[4]=c,t[5]=f,t[6]=p,t[7]=h,t[8]=d,t[9]=l,t[10]=y,t[11]=g,t[12]=m,t[13]=v,t[14]=b,t[15]=w}function L(t,e){O(t,e,e)}function U(t){var e,r,n=1;for(e=0;e<16;e++)r=t[e]+n+65535,n=Math.floor(r/65536),t[e]=r-65536*n;t[0]+=n-1+37*(n-1)}var D=function(){function t(t){this.keystore=t}return t.prototype.signToken=function(t,e){var r=this.keystore,i=r.client_id,a=r.session_id,u=r.private_key,c=r.scope,f=Math.floor(Date.now()/1e3);e||(e=n.v4());var p={uid:i,sid:a,iat:f,exp:f+3600,jti:e,sig:t,scp:c||"FULL"},h=A(u,"base64");return 64===h.length?function(t,e){var r=[A({alg:"EdDSA",typ:"JWT"}).toString("base64"),t=I(A(t))],n=I(Buffer.from(o.pki.ed25519.sign({message:r.join("."),encoding:"utf8",privateKey:e})));return r.push(n),r.join(".")}(p,h):s.sign(p,u,{algorithm:"RS512"})},t}(),R=function(t){return void 0===t&&(t=500),new Promise((function(e){setTimeout((function(){e()}),t)}))},j=function(t){return z(t.sort((function(t,e){return t>e?1:-1})).join(""))},z=function(t){return new c.SHA3(256).update(t).digest("hex")},G=function(t){return new Promise((function(e,r){f.get(t,(function(t){var r=[];t.on("data",(function(t){r.push(t)})),t.on("end",(function(){var t=Buffer.concat(r);e(t)}))})).on("error",(function(t){r(t)}))}))},F=["https://mixin-api.zeromesh.net","https://api.mixin.one"],Y=function(t,e){void 0===e&&(e="");var r,s=i.create({baseURL:F[0],headers:{"Content-Type":"application/json;charset=UTF-8"},timeout:3e3});return t&&(r=new D(t)),s.interceptors.request.use((function(t){var i=t.method,o=t.data,a=s.getUri(t),u=n.v4();t.headers["x-request-id"]=u;var c="";return e?c=e:r&&(c=r.signToken(q(i,a,o),u)),t.headers.Authorization="Bearer "+c,t})),s.interceptors.response.use((function(t){var e=t.data,r=e.data,n=e.error;if(n){try{n.request_id=t.headers["x-request-id"]}catch(e){console.log(e,t.config)}return n}return r}),function(){var t=w(B.mark((function t(e){return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!["ETIMEDOUT","ECONNABORTED"].includes(e.code)){t.next=5;break}return s.defaults.baseURL=e.config.baseURL=e.config.baseURL===F[0]?F[1]:F[0],t.next=4,R();case 4:return t.abrupt("return",s(e.config));case 5:return t.abrupt("return",Promise.reject(e));case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),s},J=Y(),K=function(){function t(){}var e=t.prototype;return e.userMe=function(){return this.request.get("/me")},e.readUser=function(t){return this.request.get("/users/"+t)},e.readBlockUsers=function(){return this.request.get("/blocking_users")},e.readUsers=function(t){return this.request.post("/users/fetch",t)},e.readFriends=function(){return this.request.get("/friends")},e.searchUser=function(t){return this.request.get("/search/"+t)},e.createUser=function(){var t=w(B.mark((function t(e,r){var n,i,s,o,u;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r){t.next=2;break}return t.abrupt("return",this.request.post("/users",{full_name:e,session_secret:r}));case 2:return n=a.pki.ed25519.generateKeyPair(),i=n.publicKey,s=n.privateKey,o={full_name:e,session_secret:Buffer.from(i).toString("base64")},t.next=6,this.request.post("/users",o);case 6:return(u=t.sent).public_key=i.toString("base64"),u.private_key=s.toString("base64"),t.abrupt("return",u);case 10:case"end":return t.stop()}}),t,this)})));return function(e,r){return t.apply(this,arguments)}}(),e.modifyProfile=function(t,e){return this.updateProfile({full_name:t,avatar_base64:e})},e.updateProfile=function(t){return this.request.post("/me/preferences",t)},e.modifyRelationships=function(t){return this.request.post("/relationships",t)},t}(),W=function(){function t(){}var e=t.prototype;return e.createAddress=function(t,e){return t.pin=T(this.keystore,e),this.request.post("/addresses",t)},e.readAddress=function(t){return this.request.get("/addresses/"+t)},e.readAddresses=function(t){return this.request.get("/assets/"+t+"/addresses")},e.deleteAddress=function(t,e){return e=T(this.keystore,e),this.request.post("/addresses/"+t+"/delete",{pin:e})},t}(),H=function(){function t(){}var e=t.prototype;return e.updateApp=function(t,e){return this.request.post("/apps/"+t,e)},e.readFavoriteApps=function(t){return this.request.get("/users/"+t+"/apps/favorite")},e.favoriteApp=function(t){return this.request.post("/apps/"+t+"/favorite")},e.unfavoriteApp=function(t){return this.request.post("/apps/"+t+"/unfavorite")},t}(),V=function(){function t(){}var e=t.prototype;return e.readAsset=function(t){return this.request.get("/assets/"+t)},e.readAssets=function(){return this.request.get("/assets")},e.readAssetFee=function(t){return this.request.get("/assets/"+t+"/fee")},e.readExchangeRates=function(){return this.request.get("/fiats")},e.readAssetNetworkTicker=function(t,e){return this.request.get("/network/ticker",{params:{offset:e,asset:t}})},t}(),X=function(){function t(){}var e=t.prototype;return e.createAttachment=function(){return this.request.post("/attachments")},e.showAttachment=function(t){return this.request.get("/attachments/"+t)},e.uploadFile=function(){var t=w(B.mark((function t(e){var r,n,i,s;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.createAttachment();case 2:return n=(r=t.sent).view_url,i=r.upload_url,s=r.attachment_id,t.next=8,$(i,e);case 8:return t.abrupt("return",{view_url:n,attachment_id:s});case 9:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),t}();function $(t,e){return Q.apply(this,arguments)}function Q(){return(Q=w(B.mark((function t(e,r){return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",i.create()({url:e,method:"PUT",data:r,headers:{"x-amz-acl":"public-read","Content-Type":"application/octet-stream"},maxContentLength:2147483648}));case 1:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Z=function(){function t(){}var e=t.prototype;return e.createConversation=function(t){return this.request.post("/conversations",t)},e.updateConversation=function(t,e){return this.request.post("/conversations/"+t,e)},e.createContactConversation=function(t){return this.createConversation({category:"CONTACT",conversation_id:this.uniqueConversationID(this.keystore.client_id,t),participants:[{user_id:t}]})},e.createGroupConversation=function(t,e,r){return this.createConversation({category:"GROUP",conversation_id:t,name:e,participants:r})},e.readConversation=function(t){return this.request.get("/conversations/"+t)},e.managerConversation=function(t,e,r){return this.request.post("/conversations/"+t+"/participants/"+e,r)},e.addParticipants=function(t,e){var r=e.map((function(t){return{user_id:t}}));return this.managerConversation(t,"ADD",r)},e.removeParticipants=function(t,e){var r=e.map((function(t){return{user_id:t}}));return this.managerConversation(t,"REMOVE",r)},e.adminParticipants=function(t,e){var r=e.map((function(t){return{user_id:t,role:"ADMIN"}}));return this.managerConversation(t,"ROLE",r)},e.rotateConversation=function(t){return this.request.post("/conversations/"+t+"/rotate")},t}();function tt(t){var e=r.createHash("sha512");e.update(t.subarray(0,32));var n=e.digest();return n[0]&=248,n[31]&=127,n[31]|=64,n.subarray(0,32)}function et(t){var e=t.map((function(t){return t.session_id}));e.sort();for(var n,i=r.createHash("md5"),s=k(e);!(n=s()).done;)i.update(n.value);return i.digest("hex")}function rt(t,e,i){var s=Buffer.from(t,"base64"),o=Buffer.from(i,"base64"),a=s.length;if(a<111)throw new Error("invalid data size");for(var u=35+64*s.readUInt16LE(1),c=Buffer.alloc(0),f=35;f<u;f+=64)if(n.v4({random:s.subarray(f,f+16)})===e){var p=s.subarray(3,35),h=tt(o),l=d.scalarMult(h,p),y=s.subarray(f+16,f+32),g=r.createDecipheriv("aes-256-cbc",l,y);c=s.subarray(f+32,f+64),c=g.update(c),c=Buffer.concat([c,g.final()]);break}if(16!==c.length)throw new Error("session id not found");var m=s.subarray(u,u+12),v=r.createDecipheriv("aes-128-gcm",c,m);v.setAuthTag(s.subarray(a-16));var b=v.update(s.subarray(u+12,a-16));return(b=Buffer.concat([b,v.final()])).toString("base64")}var nt=function(t,e,i){var s=r.randomBytes(16),o=r.randomBytes(12),a=r.createCipheriv("aes-128-gcm",s,o),u=a.update(t),c=a.final(),f=a.getAuthTag(),p=Buffer.concat([u,c,f]),h=Buffer.alloc(2);h.writeUInt16LE(e.length);for(var y,g=l.Point.fromHex(i.subarray(32)).toX25519(),m=Buffer.from([]),v=k(e);!(y=v()).done;){var b=y.value,w=Buffer.from(b.public_key,"base64"),x=tt(i),_=d.scalarMult(x,w),E=r.randomBytes(16),M=Buffer.alloc(16).fill(16),B=Buffer.concat([s,M]),T=Buffer.alloc(16+B.length);T.set(E,0);var A=r.createCipheriv("aes-256-cbc",_,E).update(B);T.set(A,16);var q=n.parse(b.session_id);m=Buffer.concat([m,q,T])}var I=Buffer.from([1]);return(I=Buffer.concat([I,h,g,m,o,p])).toString("base64url")},it=function(t,e){var n=Buffer.from(e,"base64").subarray(0,32),i=t.subarray(0,16),s=t.subarray(16,t.byteLength-32),o=r.createDecipheriv("aes-256-cbc",n,i);return s=o.update(s),Buffer.concat([s,o.final()])},st={},ot=function(){function t(){}var e=t.prototype;return e.sendAcknowledgements=function(t){return this.request.post("/acknowledgements",t)},e.sendAcknowledgement=function(t){return this.sendAcknowledgements([t])},e.sendMessage=function(t){return this.request.post("/messages",t)},e.sendMessages=function(t){return this.request.post("/messages",t)},e.sendMsg=function(t,e,r){return"object"==typeof r&&(r=JSON.stringify(r)),this.sendMessage({category:e,recipient_id:t,conversation_id:this.uniqueConversationID(this.keystore.client_id,t),message_id:this.newUUID(),data:Buffer.from(r).toString("base64url")})},e.sendMessageText=function(t,e){return this.sendMsg(t,"PLAIN_TEXT",e)},e.sendMessagePost=function(t,e){return this.sendMsg(t,"PLAIN_POST",e)},e.sendTextMsg=function(t,e){return this.sendMsg(t,"PLAIN_TEXT",e)},e.sendPostMsg=function(t,e){return this.sendMsg(t,"PLAIN_POST",e)},e.sendImageMsg=function(t,e){return this.sendMsg(t,"PLAIN_IMAGE",e)},e.sendDataMsg=function(t,e){return this.sendMsg(t,"PLAIN_DATA",e)},e.sendStickerMsg=function(t,e){return this.sendMsg(t,"PLAIN_STICKER",e)},e.sendContactMsg=function(t,e){return this.sendMsg(t,"PLAIN_CONTACT",e)},e.sendAppCardMsg=function(t,e){return this.sendMsg(t,"APP_CARD",e)},e.sendAudioMsg=function(t,e){return this.sendMsg(t,"PLAIN_AUDIO",e)},e.sendLiveMsg=function(t,e){return this.sendMsg(t,"PLAIN_LIVE",e)},e.sendVideoMsg=function(t,e){return this.sendMsg(t,"PLAIN_VIDEO",e)},e.sendLocationMsg=function(t,e){return this.sendMsg(t,"PLAIN_LOCATION",e)},e.sendAppButtonMsg=function(t,e){return this.sendMsg(t,"APP_BUTTON_GROUP",e)},e.sendRecallMsg=function(t,e){return this.sendMsg(t,"MESSAGE_RECALL",e)},e.sendEncryptMessage=function(t){return this._sendEncryptMsg(t.recipient_id,t.category,t.data,!1,t.message_id,t.conversation_id)},e._sendEncryptMsg=function(){var t=w(B.mark((function t(e,r,n,i,s,o){var a,u,c,f,p;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===i&&(i=!1),r.startsWith("ENCRYPTED_")){t.next=3;break}return t.abrupt("return",Promise.reject("category must start with ENCRYPTED_"));case 3:return"object"==typeof n&&(n=JSON.stringify(n)),t.next=6,this.getSessionsWithCache([e]);case 6:return a=t.sent,u=nt(Buffer.from(n),a[e],Buffer.from(this.keystore.private_key,"base64")),c=et(a[e]||[]),f=a[e].map((function(t){return{session_id:t.session_id}})),s||(s=this.newUUID()),o||(o=this.uniqueConversationID(this.keystore.client_id,e)),t.next=14,this.sendEncryptMessagesRaw([{category:r,recipient_id:e,conversation_id:o,message_id:s,data_base64:u,checksum:c,recipient_sessions:f}]);case 14:if("SUCCESS"!==(p=t.sent[0]).state&&0!==p.sessions.length&&!i){t.next=18;break}return t.abrupt("return",p);case 18:return this.cacheSession(p.sessions),t.abrupt("return",this._sendEncryptMsg(e,r,n,!0,s));case 20:case"end":return t.stop()}}),t,this)})));return function(e,r,n,i,s,o){return t.apply(this,arguments)}}(),e.sendEncryptMessagesRaw=function(t){return this.request.post("/encrypted_messages",t)},e.sendEncryptTextMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_TEXT",e)},e.sendEncryptPostMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_POST",e)},e.sendEncryptImageMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_IMAGE",e)},e.sendEncryptDataMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_DATA",e)},e.sendEncryptStickerMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_STICKER",e)},e.sendEncryptContactMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_CONTACT",e)},e.sendEncryptAudioMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_AUDIO",e)},e.sendEncryptLiveMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_LIVE",e)},e.sendEncryptVideoMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_VIDEO",e)},e.sendEncryptLocationMsg=function(t,e){return this._sendEncryptMsg(t,"ENCRYPTED_LOCATION",e)},e.sendEncryptMessages=function(){var t=w(B.mark((function t(e){return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this._sendEncryptMsgs(e));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e._sendEncryptMsgs=function(){var t=w(B.mark((function t(e,r,n){var i,s,o,a,u,c,f,p,h,d,l,y,g,m,v,b,w,x,_,E;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===r&&(r=!1),void 0===n&&(n=[]),i=e.map((function(t){return t.recipient_id})),t.next=5,this.getSessionsWithCache(i);case 5:s=t.sent,o=[],a=new Map,u=k(e);case 9:if((c=u()).done){t.next=24;break}if(a.set((f=c.value).message_id,f),h=f.recipient_id,d=f.data,l=f.message_id,y=f.conversation_id,(p=f.category).startsWith("ENCRYPTED_")){t.next=15;break}throw new Error("category must start with ENCRYPTED_");case 15:g=s[h],m=nt(Buffer.from(d),g,Buffer.from(this.keystore.private_key,"base64")),v=et(g||[]),b=g.map((function(t){return{session_id:t.session_id}})),l||(l=this.newUUID()),y||(y=this.uniqueConversationID(this.keystore.client_id,h)),o.push({category:p,recipient_id:h,conversation_id:y,message_id:l,data_base64:m,checksum:v,recipient_sessions:b});case 22:t.next=9;break;case 24:return t.next=26,this.sendEncryptMessagesRaw(o);case 26:for(w=[],x=k(t.sent);!(_=x()).done;)"SUCCESS"===(E=_.value).state||r?n.push(E):(this.cacheSession(E.sessions),w.push(a.get(E.message_id)));if(0!==w.length&&!r){t.next=31;break}return t.abrupt("return",n);case 31:return t.abrupt("return",this._sendEncryptMsgs(w,!0,n));case 32:case"end":return t.stop()}}),t,this)})));return function(e,r,n){return t.apply(this,arguments)}}(),e.getSessions=function(){var t=w(B.mark((function t(e){return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.request.post("/sessions/fetch",e));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.getSessionsWithCache=function(){var t=w(B.mark((function t(e){var r,n,i,s,o,a,u;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=[],n={},i=k(e);case 3:if((s=i()).done){t.next=14;break}if(!(a=this.getSessionByCache(o=s.value))){t.next=11;break}return n[o]=a,t.abrupt("continue",12);case 11:r.push(o);case 12:t.next=3;break;case 14:if(0!==r.length){t.next=16;break}return t.abrupt("return",n);case 16:return t.next=18,this.request.post("/sessions/fetch",r);case 18:return u=this.cacheSession(t.sent),n=x({},n,u),t.abrupt("return",n);case 22:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.cacheSession=function(t){p.existsSync(".sessions")||p.mkdirSync(".sessions");var e={};for(var r in t.forEach((function(t){t.user_id&&(e[t.user_id]||(e[t.user_id]=[]),e[t.user_id].push(t))})),e){st[r]=e[r];var n=h.resolve(process.cwd(),".sessions",r+".json");p.writeFileSync(n,JSON.stringify(e[r]))}return e},e.decryptAttachmentByMsgData=function(){var t=w(B.mark((function t(e){var r,n;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("object"==typeof e){t.next=2;break}return t.abrupt("return",Promise.reject("msgData should be an object..."));case 2:if(e.attachment_id){t.next=4;break}return t.abrupt("return",Promise.reject("msgData should contain attachment_id..."));case 4:return t.next=6,this.showAttachment(e.attachment_id);case 6:return r=t.sent.view_url,t.next=10,G(r);case 10:if(n=t.sent,e.key){t.next=13;break}return t.abrupt("return",n);case 13:return t.abrupt("return",it(n,e.key));case 14:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.getSessionByCache=function(t){return st[t]},t}(),at=Buffer.from([0,0]),ut=Buffer.from([119,119]),ct=function(){function t(t){this.buf=t}var e=t.prototype;return e.write=function(t){this.buf=Buffer.concat([this.buf,t])},e.writeBytes=function(t){var e=t.byteLength;if(e>1365)throw new Error("bytes too long. max length is 21 * 65, current length is "+e);this.writeInt(e),this.write(t)},e.writeInt=function(t){if(t>65535)throw new Error("int overflow");var e=Buffer.alloc(2);e.writeUInt16BE(t),this.write(e)},e.writeUint64=function(t){var e=Buffer.alloc(8);e.writeBigUInt64BE(t),this.write(e)},e.writeUint16=function(t){var e=Buffer.alloc(2);e.writeUInt16BE(t),this.write(e)},e.writeInteger=function(t){var e=function(t){for(var e=[];0!==t;)e.unshift(255&t),t=t/Math.pow(2,8)|0;return e}(t);this.writeInt(e.length),this.write(Buffer.from(e))},e.writeSlice=function(t){var e=t.length;if(e>128)throw new Error("slice too long");this.write(Buffer.from([e])),this.write(t)},e.writeUUID=function(t){for(var e=n.parse(t),r=0;r<e.length;r++)this.write(Buffer.from([e[r]]))},e.encodeInput=function(t){this.write(Buffer.from(t.hash,"hex")),this.writeInt(t.index),t.genesis||(t.genesis=""),this.writeInt(t.genesis.length),this.write(Buffer.from(t.genesis));var e=t.deposit;if(void 0===e)this.write(at);else{this.write(ut),this.write(Buffer.from(e.chain,"hex"));var r=Buffer.from(e.asset);this.writeInt(r.byteLength),this.write(r);var n=Buffer.from(e.transaction);this.writeInt(n.byteLength),this.write(n),this.writeUint64(e.index),this.writeInteger(e.amount)}var i=t.mint;void 0===i?this.write(at):(this.write(ut),i.group||(i.group=""),this.writeInt(i.group.length),this.write(Buffer.from(i.group)),this.writeUint64(i.batch),this.writeInteger(i.amount))},e.encodeOutput=function(t){var e=this;t.type||(t.type=0),this.write(Buffer.from([0,t.type])),this.writeInteger(new y.BigNumber(1e8).times(new y.BigNumber(t.amount)).toNumber()),this.writeInt(t.keys.length),t.keys.forEach((function(t){return e.write(Buffer.from(t,"hex"))})),this.write(Buffer.from(t.mask,"hex"));var r=Buffer.from(t.script,"hex");this.writeInt(r.byteLength),this.write(r);var n=t.withdrawal;if(void 0===n)this.write(at);else{this.write(ut),this.write(Buffer.from(n.chain,"hex"));var i=Buffer.from(n.asset);this.writeInt(i.byteLength),this.write(i),n.address||(n.address="");var s=Buffer.from(n.address);this.writeInt(s.byteLength),this.write(s);var o=Buffer.from(n.tag);this.writeInt(o.byteLength),this.write(o)}},e.encodeAggregatedSignature=function(t){var e=this;if(this.writeInt(65535),this.writeInt(65281),this.write(Buffer.from(t.signature,"hex")),0===t.signers.length)return this.write(Buffer.from([0])),void this.writeInt(0);t.signers.forEach((function(e,r){if(r>0&&e<=t.signers[r-1])throw new Error("signers not sorted");if(e>65535)throw new Error("signer overflow")}));var r=t.signers[t.signers.length-1];if((1+(r/8|0)|0)>2*t.signature.length)return this.write(Buffer.from([1])),this.writeInt(t.signature.length),void t.signers.forEach((function(t){return e.writeInt(t)}));var n=Buffer.alloc(1+(r/8|0)|0);t.signers.forEach((function(t){return n[t/8|0]^=1<<(t%8|0)})),this.write(Buffer.from([0])),this.writeInt(n.length),this.write(n)},e.encodeSignature=function(t){var e=this,r=Object.keys(t).map((function(e,r){return{index:e,sig:t[r]}})).sort((function(t,e){return Number(t.index)-Number(e.index)}));this.writeInt(r.length),r.forEach((function(t){e.writeUint16(Number(t.index)),e.write(Buffer.from(t.sig,"hex"))}))},t}();function ft(t){var e=new ct(ut);e.write(Buffer.from([0,t.version])),e.write(Buffer.from(t.asset,"hex")),e.writeInt(t.inputs.length),t.inputs.forEach((function(t){return e.encodeInput(t)})),e.writeInt(t.outputs.length),t.outputs.forEach((function(t){return e.encodeOutput(t)}));var r=Buffer.from(t.extra,"hex");if(e.writeInt(r.byteLength),e.write(r),t.aggregated)e.encodeAggregatedSignature(t.aggregated);else{var n=t.signatures?Object.keys(t.signatures).length:0;if(65535==n)throw new Error("signatures overflow");e.writeInt(n),n>0&&e.encodeSignature(t.signatures)}return e.buf.toString("hex")}function pt(t,e,r){return{mask:t.mask,keys:t.keys,amount:Number(e).toFixed(8),script:Buffer.from([255,254,r]).toString("hex")}}var ht=function(){function t(){}var e=t.prototype;return e.readMultisigs=function(t,e){return this.request.get("/multisigs",{params:{offset:t,limit:e}})},e.readMultisigOutput=function(t){return this.request.get("/multisigs/outputs/"+t)},e.readMultisigOutputs=function(t,e,r,n){if(t.length>0&&e<1||e>t.length)return Promise.reject(new Error("Invalid threshold or members"));var i={threshold:Number(e),offset:r,limit:n};return i.members=j(t),this.request.get("/multisigs/outputs",{params:i})},e.createMultisig=function(t,e){return this.request.post("/multisigs/requests",{action:t,raw:e})},e.signMultisig=function(t,e){return e=T(this.keystore,e),this.request.post("/multisigs/requests/"+t+"/sign",{pin:e})},e.cancelMultisig=function(t){return this.request.post("/multisigs/requests/"+t+"/cancel")},e.unlockMultisig=function(t,e){return e=T(this.keystore,e),this.request.post("/multisigs/requests/"+t+"/unlock",{pin:e})},e.readGhostKeys=function(t,e){return this.request.post("/outputs",{receivers:t,index:e,hint:""})},e.batchReadGhostKeys=function(t){return this.request.post("/outputs",t)},e.makeMultisignTransaction=function(){var t=w(B.mark((function t(e){var r,n,i,s,o,a,u,c,f,p,h,d;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(n=e.memo,i=e.outputs,s={version:2,asset:z((r=e.inputs)[0].asset_id),extra:I(Buffer.from(n)),inputs:[],outputs:[]},o=k(r);!(a=o()).done;)s.inputs.push({hash:(u=a.value).transaction_hash,index:u.output_index});for(c=r.reduce((function(t,e){return t.plus(new y.BigNumber(e.amount))}),new y.BigNumber(0)),f=k(i);!(p=f()).done;)c=c.minus(new y.BigNumber(p.value.amount));return c.gt(new y.BigNumber(0))&&i.push({receivers:r[0].members,threshold:r[0].threshold,amount:c.toString()}),h=[],i.forEach((function(t,r){return h.push({receivers:t.receivers,index:r,hint:e.hint})})),t.next=10,this.batchReadGhostKeys(h);case 10:return d=t.sent,i.forEach((function(t,e){return s.outputs.push(pt(d[e],t.amount,t.threshold))})),t.abrupt("return",ft(s));case 13:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),t}(),dt=function(){function t(){}var e=t.prototype;return e.verifyPin=function(t){return t=T(this.keystore,t),this.request.post("/pin/verify",{pin:t})},e.modifyPin=function(t,e){return t=T(this.keystore,t),e&&(e=T(this.keystore,e)),this.request.post("/pin/update",{old_pin:e,pin:t})},e.readTurnServers=function(){return this.request.get("/turn")},t}(),lt=function(){function t(){}var e=t.prototype;return e.readSnapshots=function(t){return this.request.get("/snapshots",{params:t})},e.readNetworkSnapshots=function(t){return this.request.get("/network/snapshots",{params:t})},e.readSnapshot=function(t){return this.request.get("/snapshots/"+t)},e.readNetworkSnapshot=function(t){return this.request.get("/network/snapshots/"+t)},t}(),yt=function(){function t(){}var e=t.prototype;return e.verifyPayment=function(t){return this.request.post("/payments",t)},e.transfer=function(t,e){return t.pin=T(this.keystore,e),this.request.post("/transfers",t)},e.readTransfer=function(t){return this.request.get("/transfers/trace/"+t)},e.transaction=function(t,e){return t.pin=T(this.keystore,e),this.request.post("/transactions",t)},e.sendRawTransaction=function(t){return this.request.post("/external/proxy",{method:"sendrawtransaction",params:[t]})},e.withdraw=function(t,e){return t.pin=T(this.keystore,e),this.request.post("/withdrawals",t)},t}(),gt=function(){function t(){}var e=t.prototype;return e.authorizeToken=function(t,e,r){return e||(e=this.keystore.client_secret),e?this.request.post("/oauth/token",{client_secret:e,code:t,code_verifier:r,client_id:this.keystore.client_id}):Promise.reject(new Error("client_secret required"))},e.getAuthorizeCode=function(){var t=w(B.mark((function t(e){var r,n,i,s,o,a,u;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.client_id,n=e.scopes,i=e.pin,t.next=3,this.getAuthorizeData(r,n);case 3:return o=(s=t.sent).authorization_id,a=s.scopes,u=T(this.keystore,i),t.abrupt("return",this.request.post("/oauth/authorize",{authorization_id:o,scopes:a,pin_base64:u}));case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.getAuthorizeData=function(t,e){var r=this;return new Promise((function(n,i){var s,o=new m("wss://blaze.mixin.one","Mixin-OAuth-1");e||(e=[]),e.includes("PROFILE:READ")||e.push("PROFILE:READ");var a=null==(s=e)?void 0:s.join(" ");o.addEventListener("message",(function(t){var e=g.ungzip(t.data,{to:"string"}),r=JSON.parse(e);return o.close(),r.data?n(r.data):i(r)})),o.addEventListener("open",(function(){return void 0===e&&(e=""),void o.send(g.gzip(JSON.stringify({id:r.newUUID().toUpperCase(),action:"REFRESH_OAUTH_CODE",params:{client_id:t,scope:a,authorization_id:e,code_challenge:""}})));var e}))}))},t}();function mt(t,e,r){var i=new ct(Buffer.from("NFO","utf8"));return i.write(Buffer.from([0])),i.write(Buffer.from([1])),i.writeUint64(BigInt(1)),i.writeUUID("43d61dcd-e413-450d-80b8-101d5e903357"),i.writeSlice(Buffer.from("3c8c161a18ae2c8b14fda1216fff7da88c419b5d","hex")),i.writeSlice(Buffer.from(n.parse(t))),i.writeSlice(Buffer.from(n.parse(e))),i.writeSlice(Buffer.from(z(r),"hex")),I(i.buf)}var vt=["4b188942-9fb0-4b99-b4be-e741a06d1ebf","dd655520-c919-4349-822f-af92fabdbdf4","047061e6-496d-4c35-b06b-b0424a8a400d","acf65344-c778-41ee-bacb-eb546bacfb9f","a51006d0-146b-4b32-a2ce-7defbf0d7735","cf4abd9c-2cfa-4b5a-b1bd-e2b61a83fabd","50115496-7247-4e2c-857b-ec8680756bee"],bt=function(){function t(){}var e=t.prototype;return e.newMintCollectibleTransferInput=function(t){var e=t.trace_id,r=t.collection_id,n=t.token_id,i=t.content;if(!(e&&r&&n&&i))throw new Error("Missing parameters");return{asset_id:"c94ac88f-4671-3976-b60a-09064f1811e8",amount:"0.001",trace_id:e,memo:mt(r,n,i),opponent_multisig:{receivers:vt,threshold:5}}},e.readCollectibleToken=function(t){return this.request.get("/collectibles/tokens/"+t)},e.readCollectibleOutputs=function(t,e,r,n){var i=j(t);return this.request.get("/collectibles/outputs",{params:{members:i,threshold:e,offset:r,limit:n}})},e.makeCollectibleTransactionRaw=function(){var t=w(B.mark((function t(e){var r,n,i,s,o;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=e.receivers,s=e.threshold,o={version:2,asset:(r=e.token).mixin_id,extra:r.nfo,inputs:[{hash:(n=e.output).transaction_hash,index:n.output_index}]},t.next=4,this.batchReadGhostKeys([{receivers:i,index:0,hint:n.output_id}]);case 4:return o.outputs=[pt(t.sent[0],n.amount,s)],t.abrupt("return",ft(o));case 7:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.createCollectibleRequest=function(t,e){return this.request.post("/collectibles/requests",{action:t,raw:e})},e.signCollectibleRequest=function(t,e){return e=T(this.keystore,e),this.request.post("/collectibles/requests/"+t+"/sign",{pin:e})},e.cancelCollectibleRequest=function(t){return this.request.post("/collectibles/requests/"+t+"/cancel")},e.unlockCollectibleRequest=function(t,e){return e=T(this.keystore,e),this.request.post("/collectibles/requests/"+t+"/unlock",{pin:e})},t}(),wt=[{inputs:[{internalType:"bytes",name:"raw",type:"bytes"},{internalType:"uint128",name:"pid",type:"uint128"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"at",type:"address"},{indexed:!1,internalType:"uint256",name:"id",type:"uint256"}],name:"AssetCreated",type:"event"},{anonymous:!1,inputs:[{components:[{internalType:"uint64",name:"nonce",type:"uint64"},{internalType:"address",name:"user",type:"address"},{internalType:"address",name:"asset",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes",name:"extra",type:"bytes"},{internalType:"uint64",name:"timestamp",type:"uint64"},{internalType:"uint256[2]",name:"sig",type:"uint256[2]"}],indexed:!1,internalType:"struct Registry.Event",name:"evt",type:"tuple"}],name:"MixinEvent",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"bytes",name:"",type:"bytes"}],name:"MixinTransaction",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"at",type:"address"},{indexed:!1,internalType:"bytes",name:"members",type:"bytes"}],name:"UserCreated",type:"event"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"GROUP",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"HALTED",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[],name:"INBOUND",outputs:[{internalType:"uint64",name:"",type:"uint64"}],stateMutability:"view",type:"function"},{inputs:[],name:"OUTBOUND",outputs:[{internalType:"uint64",name:"",type:"uint64"}],stateMutability:"view",type:"function"},{inputs:[],name:"PID",outputs:[{internalType:"uint128",name:"",type:"uint128"}],stateMutability:"view",type:"function"},{inputs:[],name:"VERSION",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"addresses",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"assets",outputs:[{internalType:"uint128",name:"",type:"uint128"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint128",name:"",type:"uint128"}],name:"balances",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"burn",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"asset",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"claim",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"contracts",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"deposits",outputs:[{internalType:"uint128",name:"",type:"uint128"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes",name:"raw",type:"bytes"}],name:"evolve",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes",name:"raw",type:"bytes"}],name:"halt",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes",name:"raw",type:"bytes"}],name:"iterate",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes",name:"raw",type:"bytes"}],name:"mixin",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"users",outputs:[{internalType:"bytes",name:"",type:"bytes"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_storageContract",type:"address"},{internalType:"bytes32",name:"_key",type:"bytes32"},{internalType:"bytes",name:"raw",type:"bytes"}],name:"writeValue",outputs:[],stateMutability:"nonpayable",type:"function"}],xt=["d5a3a450-5619-47af-a3b1-aad08e6e10dd","9d4a18aa-9b0a-40ed-ba57-ce8fbbbc6deb","2f82a56a-7fae-4bdd-bc4d-aad5005c5041","f7f33be1-399a-4d29-b50c-44e5f01cbb1b","23a070df-6b87-4b66-bdd4-f009702770c9","2385639c-eac1-4a38-a7f6-597b3f0f5b59","ab357ad7-8828-4173-b3bb-0600c518eab2"],_t=function(){var t=w(B.mark((function t(e){var r,i;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=kt(),t.next=3,r.assets(e);case 3:if((i=t.sent)instanceof v.BigNumber&&(i=i._hex),!(i.length<=2)){t.next=7;break}return t.abrupt("return","");case 7:return i=i.slice(2),t.abrupt("return",n.stringify(Buffer.from(i,"hex")));case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Et=function(){var t=w(B.mark((function t(e){var r,i;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=kt(),t.next=3,r.users(e);case 3:if((i=t.sent)instanceof v.BigNumber&&(i=i._hex),!(i.length<=2)){t.next=7;break}return t.abrupt("return","");case 7:return i=(i=i.slice(6)).slice(0,32),t.abrupt("return",n.stringify(Buffer.from(i,"hex")));case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),kt=function(t){return void 0===t&&(t="0x3c84B6C98FBeB813e05a7A7813F0442883450B1F"),new v.ethers.Contract(t,wt,new v.ethers.providers.JsonRpcProvider("https://geth.mvm.dev"))},Mt=function(t,e){t.startsWith("0x")&&(t=t.slice(2));var r=new ct(Buffer.from([]));return r.writeInt(1),r.writeUUID(e),r.writeBytes(Buffer.from([])),r.writeBytes(Buffer.from([])),r.writeBytes(Buffer.from(t,"hex")),I(r.buf)},Bt=function(t){var e=t.method,r=t.types,n=void 0===r?[]:r,i=t.values,s=void 0===i?[]:i;if(n.length!==s.length)return"";var o=t.address.toLocaleLowerCase();o.startsWith("0x")&&(o=o.slice(2));var a=function(t,e){return v.utils.id(t+"("+e.join(",")+")").slice(2,10)}(e,n);if(n.length!=s.length)throw new Error("error: types.length!=values.length");return s.length>0&&(a+=(new v.ethers.utils.AbiCoder).encode(n,s).slice(2)),""+o+Buffer.from([0,a.length/2]).toString("hex")+a},Tt=function(t){if(0===t.length)return"";for(var e=Buffer.from([0,t.length]).toString("hex"),r=0;r<t.length;r++)e+=Buffer.from(Bt(t[r]));return"0x"+e},At=function(){function t(){}return t.prototype.paymentGeneratorByContract=function(){var t=w(B.mark((function t(e){var r,n,i,s,o,a,u,c,f;return B.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.contract||e.contracts){t.next=2;break}throw new Error("error: contract or contracts is required");case 2:if(e.contract&&(e.contracts=[e.contract]),r=Tt(e.contracts),i=(n=e.payment||{}).asset,s=n.amount,o=n.trace,u=void 0===(a=n.type)?"payment":a,c=Mt(r,"bd670872-76ce-3263-b933-3aa337e212a4").slice(2),f={asset_id:i||"965e5c6e-434c-3fa9-b780-c50f43cd955c",amount:s||"0.00000001",trace_id:o||this.newUUID(),memo:c,opponent_multisig:{receivers:xt,threshold:5}},"tx"!==u){t.next=9;break}return t.abrupt("return",f);case 9:if("payment"!==u){t.next=11;break}return t.abrupt("return",this.verifyPayment(f));case 11:throw new Error("error: type is invalid. type should be tx or payment");case 12:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),t}(),qt=function(){function t(t,e){if(!t&&!e)throw new Error("keystore or token required");this.keystore=t,this.request=Y(t,e)}var r=t.prototype;return r.newUUID=function(){return n.v4()},r.uniqueConversationID=function(t,r){var n=t,i=r;n>i&&(n=r,i=t);var s=e.createHash("md5");s.update(n),s.update(i);var o=s.digest();o[6]=15&o[6]|48,o[8]=63&o[8]|128;var a=Array.from(o,(function(t){return("0"+(255&t).toString(16)).slice(-2)})).join("");return a.slice(0,8)+"-"+a.slice(8,12)+"-"+a.slice(12,16)+"-"+a.slice(16,20)+"-"+a.slice(20,32)},t}();[W,H,V,X,Z,ot,ht,dt,lt,yt,K,bt,At,gt].forEach((function(t){return function(t,e){for(var r in e.prototype)t.prototype[r]=e.prototype[r]}(qt,t)}));var It="wss://blaze.mixin.one/";exports.BlazeClient=function(t){var e,r;function n(e,r){var n;return(n=t.call(this,e)||this).url=It,n.isAlive=!1,n.options={parse:!1,syncAck:!1},r&&(n.options=r),n}r=t,(e=n).prototype=Object.create(r.prototype),e.prototype.constructor=e,_(e,r);var i=n.prototype;return i.loopBlaze=function(t){if(!t.onMessage)throw new Error("OnMessage not set");this.h=t,this._loopBlaze()},i._loopBlaze=function(){var t=this,e={Authorization:"Bearer "+new D(this.keystore).signToken(q("GET","/"),"")};this.ws=new m(this.url,"Mixin-Blaze-1",{headers:e,handshakeTimeout:3e3}),this.ws.onmessage=function(){var e=w(B.mark((function e(r){var n,i;return B.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.decode(r.data)){e.next=3;break}return e.abrupt("return");case 3:if(i.category&&i.category.startsWith("ENCRYPTED_")&&(i.data=rt(i.data_base64,t.keystore.session_id,t.keystore.private_key)),null!=(n=t.options)&&n.parse&&i.data&&(i.data=Buffer.from(i.data,"base64").toString(),i.data))try{i.data=JSON.parse(i.data)}catch(t){}if("ACKNOWLEDGE_MESSAGE_RECEIPT"!==i.source||!t.h.onAckReceipt){e.next=10;break}return e.next=8,t.h.onAckReceipt(i);case 8:e.next=22;break;case 10:if("SYSTEM_CONVERSATION"!==i.category||!t.h.onConversation){e.next=15;break}return e.next=13,t.h.onConversation(i);case 13:e.next=22;break;case 15:if("SYSTEM_ACCOUNT_SNAPSHOT"!==i.category||!t.h.onTransfer){e.next=20;break}return e.next=18,t.h.onTransfer(i);case 18:e.next=22;break;case 20:return e.next=22,t.h.onMessage(i);case 22:if(!t.options.syncAck){e.next=25;break}return e.next=25,t.sendAcknowledgement({message_id:i.message_id,status:"READ"});case 25:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.ws.onclose=function(){clearInterval(t.pingInterval),t._loopBlaze()},this.ws.onerror=function(e){"Opening handshake has timed out"===e.message&&(t.url=t.url===It?"wss://mixin-blaze.zeromesh.net":It)},this.ws.on("ping",(function(){t.ws.pong()})),this.ws.on("pong",(function(){t.isAlive=!0})),this.ws.onopen=function(){t.isAlive=!0,t.heartbeat(),t.send_raw({id:t.newUUID(),action:"LIST_PENDING_MESSAGES"})}},i.heartbeat=function(){var t=this;this.pingInterval=setInterval((function(){if(t.ws.readyState!==m.CONNECTING){if(!t.isAlive)return t.ws.terminate();t.isAlive=!1,t.ws.ping()}}),3e4)},i.decode=function(t){var e=g.ungzip(t,{to:"string"});return JSON.parse(e).data},i.send_raw=function(t){var e=this;return new Promise((function(r){var n=Buffer.from(JSON.stringify(t),"utf-8"),i=g.gzip(n);e.ws.readyState===m.OPEN?(e.ws.send(i),r(!0)):r(!1)}))},n}(qt),exports.Client=qt,exports.MvmClient=At,exports.authorizeToken=function(t,e,r,n){return J.post("/oauth/token",{client_id:t,code:e,code_verifier:n,client_secret:r})},exports.createCollectibleRequest=function(t,e,r){return Y(void 0,t).post("/collectibles/requests",{action:e,raw:r})},exports.decryptAttachment=it,exports.getAssetIDByAddress=_t,exports.getContractByAssetID=function(t){return kt().contracts("0x"+Buffer.from(n.parse(t)).toString("hex"))},exports.getContractByUserIDs=function(t,e){"string"==typeof t&&(t=[t]),e||(e=t.length);var r=new ct(Buffer.from([]));return r.writeInt(t.length),t.forEach((function(t){return r.writeUUID(t)})),r.writeInt(e),kt().contracts(v.utils.keccak256("0x"+r.buf.toString("hex")))},exports.getSignPIN=T,exports.getUserIDByAddress=Et,exports.mixinRequest=J,exports.readAddresses=function(t,e){return Y(void 0,t).get("/assets/"+e+"/addresses")},exports.readAsset=function(t,e){return Y(void 0,t).get("/assets/"+e)},exports.readAssets=function(t){return Y(void 0,t).get("/assets")},exports.readBlockUsers=function(t){return Y(void 0,t).get("/blocking_users")},exports.readConversation=function(t,e){return Y(void 0,t).get("conversations/"+e)},exports.readExternalAddressesCheck=function(t){return J.get("/external/addresses/check",{params:t})},exports.readExternalTransactions=function(t){return J.get("/external/transactions",{params:t})},exports.readFriends=function(t){return Y(void 0,t).get("/friends")},exports.readNetworkAsset=function(t){return J.get("/network/assets/"+t)},exports.readNetworkAssetsMultisig=function(){return J.get("/network/assets/multisig")},exports.readNetworkAssetsTop=function(){return J.get("/network/assets/top")},exports.readNetworkChains=function(){return J.get("/network/chains")},exports.readNetworkSnapshot=function(t){return J.get("/network/snapshots/"+t)},exports.readNetworkSnapshots=function(t){return J.get("/network/snapshots",{params:t})},exports.readNetworkTicker=function(t,e){return J.get("/network/ticker",{params:{asset:t,offset:e}})},exports.readSnapshot=function(t,e){return Y(void 0,t).get("/snapshots/"+e)},exports.readSnapshots=function(t,e){return Y(void 0,t).get("/snapshots",{params:e})},exports.request=Y,exports.searchNetworkAsset=function(t){return J.get("/network/assets/search/"+t)},exports.sendExternalProxy=function(t,e){return J.post("/external/proxy",{method:t,params:e})},exports.userMe=function(t){return Y(void 0,t).get("/me")},exports.verifyPayment=function(t){return J.post("/payments",t)};
//# sourceMappingURL=mixin-node-sdk.cjs.production.min.js.map
